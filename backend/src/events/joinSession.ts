import { Server, Socket } from 'socket.io';
import { sessionStore } from '../sessionStore';
import { randomUUID } from 'crypto';

interface JoinSessionData {
  code: string;
  nickname: string;
}

export function handleJoinSession(io: Server, socket: Socket, data: JoinSessionData) {
  try {
    const { code, nickname } = data;

    // Validate input
    if (!code || !nickname || nickname.trim().length === 0) {
      socket.emit('error', { message: 'Code and nickname are required' });
      return;
    }

    // Find session
    const session = sessionStore.getSessionByCode(code.toUpperCase());

    if (!session) {
      socket.emit('error', { message: 'Invalid game code' });
      return;
    }

    if (session.status !== 'WAITING') {
      socket.emit('error', { message: 'Game has already started' });
      return;
    }

    // Check if nickname is already taken
    const existingPlayer = Array.from(session.players.values()).find(
      (p) => p.nickname.toLowerCase() === nickname.trim().toLowerCase()
    );

    if (existingPlayer) {
      socket.emit('error', { message: 'Nickname is already taken' });
      return;
    }

    // Create new player
    const playerId = randomUUID();
    const newPlayer = {
      id: playerId,
      nickname: nickname.trim(),
      isHost: false,
      joinedAt: new Date(),
    };

    // Add player to session
    sessionStore.addPlayer(session.id, newPlayer, socket.id);

    // Join socket room
    socket.join(`session-${session.id}`);

    // Get all players
    const allPlayers = Array.from(session.players.values());

    // Notify the new player
    socket.emit('session-joined', {
      sessionId: session.id,
      code: session.code,
      player: newPlayer,
      allPlayers,
    });

    // Broadcast to other players
    socket.to(`session-${session.id}`).emit('player-joined', {
      player: newPlayer,
    });

    console.log(`✓️ Player ${nickname} joined session ${session.code}`);
  } catch (error) {
    console.error('Error joining session:', error);
    socket.emit('error', { message: 'Failed to join session' });
  }
}
