import { Server, Socket } from 'socket.io';
import { sessionStore } from '../sessionStore';

interface StartGameData {
  sessionId: string;
}

export function handleStartGame(io: Server, socket: Socket, data: StartGameData) {
  try {
    const { sessionId } = data;

    const session = sessionStore.getSession(sessionId);

    if (!session) {
      socket.emit('error', { message: 'Session not found' });
      return;
    }

    // Check if user is host
    const playerId = sessionStore.getPlayerIdBySocket(socket.id);
    if (playerId !== session.hostId) {
      socket.emit('error', { message: 'Only host can start the game' });
      return;
    }

    if (session.status !== 'WAITING') {
      socket.emit('error', { message: 'Game has already started' });
      return;
    }

    // Update session status
    sessionStore.updateStatus(sessionId, 'PLAYING');

    // Broadcast to all players
    io.to(`session-${sessionId}`).emit('game-started', {
      sessionId,
      startedAt: new Date(),
    });

    console.log(`🚀 Game started for session ${session.code}`);
  } catch (error) {
    console.error('Error starting game:', error);
    socket.emit('error', { message: 'Failed to start game' });
  }
}
